"use strict";define("bundles/programming/views/gridSubmissions",["require","exports","module","underscore","bundles/phoenix/components/ContentPlaceholder","bundles/phoenix/lib/eventDefinitions","bundles/phoenix/lib/view","bundles/phoenix/lib/viewModel","bundles/phoenix/viewModels/input","i18n!nls/assess","bundles/programming/components/GradeHistory","bundles/programming/components/GridSubmission","bundles/programming/stores/submissionSummariesStore","bundles/programming/viewModels/submission","bundles/programming/views/gridSubmissions.html","css!bundles/phoenix/styl/containers.css","css!bundles/programming/styl/gridSubmissions"],function(require,exports,module){var _=require("underscore"),o=require("bundles/phoenix/components/ContentPlaceholder"),s=require("bundles/phoenix/lib/eventDefinitions"),r=require("bundles/phoenix/lib/view"),t=require("bundles/phoenix/lib/viewModel"),n=require("bundles/phoenix/viewModels/input"),i=require("i18n!nls/assess"),e=require("bundles/programming/components/GradeHistory"),a=require("bundles/programming/components/GridSubmission"),d=require("bundles/programming/stores/submissionSummariesStore"),l=require("bundles/programming/viewModels/submission"),m=require("bundles/programming/views/gridSubmissions.html");require("css!bundles/phoenix/styl/containers.css"),require("css!bundles/programming/styl/gridSubmissions");var u=t.extend({defaults:{state:"ready"},fsm:{states:["ready","submitting"],transitions:{ready:["submitting"],submitting:["ready"]}}}),b=r.extend({template:m,refreshInterval:15e3,events:{'click [data-js="create-submission-button"]':"createSubmission",'click [data-js="cancel-submission-button"]':"cancelSubmission"},multitracker:{namespace:"open_course_item.programing_grid_submissions",baseValues:["open_course_id","module_id","lesson_id","item_id"],definitions:{open_course_id:s.metadata("course.id"),module_id:s.metadata("lesson.module.id"),lesson_id:s.metadata("lesson.id"),item_id:s.metadata("id")},events:{render:[]}},initialize:function initialize(s){_(this).bindAll("refresh","onLoadSubmissionHistoryError","onSubmit"),_(this).extend(_(s).pick("itemMetadata","learnerAssignment","verificationDisplay","showDebugTools")),this.stateModel=new u,this.inputViewModel=new n,this.viewModel=new l(_(this).pick("itemMetadata","learnerAssignment","inputViewModel","verificationDisplay","verificationViewModel","isVerifiable"));var i="gradedProgramming"===this.itemMetadata.getTypeName();this.isVerifiable=i&&this.verificationDisplay.shouldPromptForVerification(),this.listenTo(this.viewModel,"change:filesWorkspace",this.renderGridSubmission),this.listenTo(this.viewModel,"change:submissionHistory",this.renderSubmissionHistory),this.refresh(),this.refreshIntervalId=setInterval(this.refresh,this.refreshInterval),d.on("updateError",this.onLoadSubmissionHistoryError),this.on("view:closed",this.onClosed)},onClosed:function onClosed(){this.off("view:closed",this.onClosed),clearInterval(this.refreshIntervalId)},refresh:function refresh(){this.viewModel.loadFileUploadParts().done(),this.viewModel.loadSubmissionHistory()},onLoadSubmissionHistoryError:function onLoadSubmissionHistoryError(){this.renderSubmissionHistoryError()},onSubmit:function onSubmit(){this.hideSubmitter()},createSubmission:function createSubmission(s){s.preventDefault(),this.showSubmitter()},cancelSubmission:function cancelSubmission(s){s.preventDefault(),this.hideSubmitter()},disableTogglers:function disableTogglers(){this.$$("create-submission-button").prop("disabled",!0),this.$$("cancel-submission-button").prop("disabled",!0)},enableTogglers:function enableTogglers(){this.$$("create-submission-button").prop("disabled",!1),this.$$("cancel-submission-button").prop("disabled",!1)},showSubmitter:function showSubmitter(){var s=this;this.disableTogglers(),this.stateModel.transition("submitting"),this.$$("submitter-area").addClass("bt3-col-md-5 transitioning").removeClass("bt3-hide").css({position:"relative"}),this.$$("submitter-content").css({"margin-left":"-150%"}).animate({"margin-left":"0%"},180,function(){s.enableTogglers(),s.$$("submitter-area").removeClass("transitioning")}),this.$$("submissions-area").addClass("bt3-col-md-7").removeClass("bt3-col-md-12")},hideSubmitter:function hideSubmitter(){var s=this;this.disableTogglers(),this.stateModel.transition("ready"),this.$$("submitter-area").addClass("transitioning"),this.$$("submitter-content").css({"margin-left":"0%"}).animate({"margin-left":"-150%"},180,function(){s.enableTogglers(),s.$$("submitter-area").removeClass("bt3-col-md-5 transitioning").addClass("bt3-hide").css({position:"absolute"}),s.$$("submissions-area").removeClass("bt3-col-md-7").addClass("bt3-col-md-12")})},postRender:function postRender(){this.track("render")},renderSubviews:function renderSubviews(){"files"===this.learnerAssignment.submissionBuilderSchema.get("typeName")&&(this.$$("submission-button-area").removeClass("bt3-hide"),this.renderGridSubmission()),this.renderSubmissionHistory()},renderGridSubmission:function renderGridSubmission(){this.renderReactInto(a,"GridSubmission",_.extend({filesWorkspace:this.viewModel.get("filesWorkspace"),onSubmit:this.onSubmit},_(this).pick("itemMetadata","learnerAssignment","verificationDisplay","viewModel","inputViewModel","verificationViewModel","isVerifiable")))},renderSubmissionHistoryError:function renderSubmissionHistoryError(){this.$$("submission-history").addClass("bt3-hide"),this.$$("no-submissions").addClass("bt3-hide"),this.$$("submission-history-error").removeClass("bt3-hide"),this.$$("submission-history-error").text("There was an error loading your submission history.")},renderSubmissionHistory:function renderSubmissionHistory(){this.$$("submission-history-error").addClass("bt3-hide");var s=this.viewModel.get("submissionHistory"),t=(s||[]).filter(function(s){return"started"===s.get("gradingStatus")});this.$$("in-progress-alert").toggleClass("bt3-hide",0===t.length),s&&0===s.length?(this.$$("submission-history").addClass("bt3-hide"),this.$$("no-submissions").removeClass("bt3-hide"),this.renderReactInto(o,"NoSubmissions",{style:"simple",message:[i("Graded submissions"),i("will appear here")],image:"images/icons/submission-placeholder.png",imageSize:{width:80,height:80}})):(this.$$("submission-history").removeClass("bt3-hide"),this.$$("no-submissions").addClass("bt3-hide"),this.renderReactInto(e,"Submissions",{itemMetadata:this.itemMetadata,submissions:s,verificationDisplay:this.verificationDisplay,showDebugTools:this.showDebugTools}))}});module.exports=b});